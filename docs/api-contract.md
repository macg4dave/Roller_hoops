# API contract

This document describes the API rules for Roller_hoops. The API is a **contract**, not an implementation detail.

## Principles

- REST over HTTP
- JSON only
- Explicit error responses (no silent failures)
- Versioned endpoints for stability (`/api/v1`)
- Stable IDs (UUIDs as strings)

## Canonical source

- OpenAPI is canonical: `api/openapi.yaml`
- This document explains conventions and non-obvious rules.

## Versioning

- Current version: `/api/v1`
- Breaking changes require a new version (`/api/v2`).

## Common headers

- Request correlation:
  - `X-Request-Id`: accepted from upstream, otherwise generated by the API.
  - The API echoes the effective request id in the response header (`X-Request-ID`).

## Error format

All non-2xx responses return JSON using a consistent envelope:

- `error.code` (stable string)
- `error.message` (human-readable)
- `error.details` (optional object)

Example shape:

```json
{
  "error": {
    "code": "validation_failed",
    "message": "Request body did not match schema",
    "details": {
      "field": "name"
    }
  }
}
```

## Error codes (current)

- `validation_failed`: JSON could not be decoded or failed schema validation.
- `invalid_id`: path parameter could not be parsed as a UUID.
- `not_found`: requested resource does not exist.
- `db_unavailable`: database connection is missing or not ready.
- `db_error`: unexpected persistence failure.

## Resource conventions

- IDs are UUID strings.
- `PUT` is used for full updates of a resource.
- `POST` is used for creates and command-style actions.
- Device responses include an optional `metadata` object (`owner`, `location`, `notes`). Empty strings are normalised to null.

## Endpoints (v1)

Initial endpoints (from `docs/roadmap.md`):

- Devices
  - `GET /api/v1/devices`
  - `GET /api/v1/devices/{id}`
  - `GET /api/v1/devices/{id}/name-candidates`
  - `POST /api/v1/devices`
  - `PUT /api/v1/devices/{id}`
  - `GET /api/v1/devices/export`
  - `POST /api/v1/devices/import`

- Discovery
  - `POST /api/v1/discovery/run`
  - `GET /api/v1/discovery/status`

### Discovery behaviour (v1)

- `POST /api/v1/discovery/run` accepts an optional `scope` hint; it returns a `DiscoveryRun` with a real run id (queued).
- `GET /api/v1/discovery/status` returns `{status: string, latest_run?: DiscoveryRun}`. Status is `idle` when no runs exist; otherwise it mirrors the latest runâ€™s status.
- Discovery runs are persisted in Postgres (`discovery_runs`, `discovery_run_logs`). The current implementation stubs the worker but wires the API, status, and request id propagation.

## Authentication

v1 intent:

- Authentication and sessions are owned by **ui-node**.
- `core-go` remains headless and is not exposed directly to browsers.

(Exact auth propagation and authorization rules will be pinned in OpenAPI and `docs/architecture.md` once the first implementation lands.)
